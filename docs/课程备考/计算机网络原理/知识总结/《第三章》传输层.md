# 内容概括：

1. 传输层的基本服务
2. 传输层的复用与分解
3. 停-等协议与滑动窗口协议
4. 用户数据报协议（UDP）
5. 传输控制协议（TCP）

## 1.传输层的基本服务
  1. 传输层的功能 ： 传输层的核心任务是为应用进程之间提供端到端的逻辑通信服务，主要的功能有，传输层寻址；对应用层报文进行分段和重组，对报文进行差错检测；实现进程间的端到端可靠数据传输控制；面向应用层实现复现与分解；实现端到端的流量控制；拥塞控制等。传送层协议秩序在端系统中实现，在路由器等网络设备中理论上无需实现传输层协议，在发送端，传输层从发送应用程序接受报文进行拆分分装成传输层数据报，称为传输层报文段，然后递交给网络层，网络层将其封装成网络层分组（数据报）并发送，路由器等网络设备一般只会对数据报的网络层字段进行操作，不检查传输层报文段字段。在接收端，网络层从数据报中提取传输层报文段，然后向上递交给传输层，传输层处理后提取报段中应用层数据交给接受应用进程。

  通信真正端点不是主机，而是主机运行的应用进程，传输层协议就是负责进程跟进程间的通信

  2. 传输层寻址与端口
  由于在网络环境下，因为计算机操作系统种类繁多，不同操作系统的进程标识符会有不同格式，而用进程指明为通信的端点也可不行，因为进程创建跟撤销是动态的，所以必须使用同一的方法对网络应用进行标识，这个跟操作系统无关，在TCP/IP体系结构网络中，使用协议端口号，也就是端口，然后通过利用IP地址 + 端口号，唯一标识一个通信端点，IP地址可以表示进程在哪个主机，同一主机上传输层协议端口号则可以唯一对应一个应用进程。这种称为软件端口，
  - 硬件端口：不同硬件设备交互端的接口
  - 软件端口：应用层的各种应用进程协议与传输层协议实体进行层间交互的一种地址
  传输层端口号为16位证书，其中0~1023为熟知端口号，1024~49151位登记端口号，必须在互联网数字分配结构（IANA）登记，防止重复，49152~65535为客户端口号，客户进程或者非标注服务器应用临时使用，端口只对本地有效。传输层端口号又分为以下两种
  - 服务端端口号：熟知端口号和登记端口号，IANA将熟知端口号分为TCP/IP最重要一些应用程序
  - 客户端端口号仅在客户进程运行时才动态选择，具有临时性，通常在客户进程运行时由操作系统随机选取唯一的未被使用的端口号
  3. 无连接服务与面向连接服务
   传输层提供的服务可以分为无连接服务和面向连接服务两大类
   - 无连接服务：传输之前无需对端进行任何信息交换，直接构造传输层报文段并发送 例如：邮政系统的信件通信
   - 面向连接服务：传输之前需要交换对方一些控制信息，建立逻辑连接，然后传输数据，结束后拆除连接 例如：电话连接

## 2. 传输层的复用与分解
支持众多应用进程共用同一个传输层协议，并能够将接收的数据准确交付给不同的应用进程，是传输层需要实现的一项基本功能，称为多路复用与多路分解
- 多路复用：在同一主机上，多个应用进程同时利用一个传输层协议进行网络通信，此时该传输层协议就被多个应用进程复用
- 多路分解：传输层协议接收报文段中可能封装了不同应用进程的数据，传输层协议需要将数据交付给正确对应的应用进程
  实现上面两个基本功能的关键是传输层协议能够唯一标识一个套接字

1. 无连接的多路复用与多路分解
提供给传输层无连接服务的协议是`UDP` 为UDP套接字分配端口号有两种方法
- 创建一个UDP套接字时，自动分配一个端口号（1024~65535）改端口未被其他UDP套接字使用
- 创建一个UDP套接字后，调用bind（）函数绑定一个特定的端口
UDP套接字端口号是UDP四线复用与分解的重要依据
标识UDP套接字的是一个二元组：<目的IP地址， 目的端口号> 因此，如果传输层收到两个不同源IP地址段或者端口号，但具有相同的目的IP地址跟相同的目的端口号，那么这两个报文段通过相同的目的套接字向相同的目的应用进程交付应用层数据， 也就是说，使用无连接UDP服务的应用进程，可以接收到来自任何一个主机、使用任意-一个端口号的应用进程发送的具有相同目的IP地址和目的端口号的UDP报文段。.

2. 面向连接的多路复用与多路分解
提供给传输层面向连接服务的是`TCP` 而TCP套接字与UDP套接字不同，TCP套接字是由一个四元组：<源IP地址，源端口号，目的IP地址，目的端口号>来唯一标识的，实质上，TCP通过这样一个四元组唯一标识一条TCP连接。与UDP不同的是当TCP收到两个具有不同源IP地址或不同源端口号的TCP报文段时候，几遍两个报文的目的IP地址和目的端口号相同，TCP也会降两个报文段分解到两个不同的套接字

概括来说，在Internet网络中，唯一标识套接字的基本信息是IP地址和端口号。UDP基于目的IP地址和目的端口号二元组唯一标识一个UDP套接字，从何可以实现精确分解；TCP则需要基于源IP地址，目的IP地址，源端口号，目的端口号四元组唯一标识一个TCP套接字，从而实现精确分解


## 3. 停-等协议与滑动窗口协议

由于TPC可以提供可靠数据传输服务，但是，TCP发送的报文段都是交给网络层IP传送的，而IP只能提供尽力服务，也就是不可靠的数据报传输服务。所以TCP必须采取适当的措施才能使其在基于不可靠的网络层基础上，实现可靠的数据传输，为应用层提供可靠报文传输服务。

1. 可靠数据传输基本原理

大部分传输信号（网络层提供的主机到主机的逻辑通信服务 或者 传输层提供进程到进程端对端逻辑通信服务 或者 信号传输的物理链路服务）都不是理想传输信道，会产生差错（比特跳变）。不可靠传输信道的不可靠性主要表现以下几点：
- 不可靠信道在传输数据的过程中，可能发生比特差错，也就是比特跳变，即0错成1或这1错成0的现象
- 可能出现乱序，即先发的数据报后到达，后发的数据先到达
- 可能出现数据丢失，即部分数据会在中途丢失，不能到达目的地地

实现可靠数据传输的措施主要包括以下几种：
- 差错检测：利用差错编码实现数据报传输过程中的比特差错检测（甚至纠正），数据发送发对需要检测差错的数据，进行差错编码，然后将编码后的数据发送给接收方，接收方依据相同的差错编码规则，检验数据传输过程中是否发生比特发错
- 确认：接收方向向发送方反馈接受状态。基于差错检测的监测结果，如果未发生差错，并且是接收方期望接受的数据则接受方向向发送方发送ACK数据报，称为肯定确认，标识已正确接受数据，否则发送NAK数据报，称为否定确认，标识没有正确接受数据
- 重传：发送方重新发送接收方没有正确接收的数据，发送方如果接受到接收方返回ACK数据报，则可以继续发送新的数据；如果接受到NAK，则将出错的数据重新想接收方发送，纠正出错数据传输
- 序号：确保数据按序提交，由于可能出现数据乱序到达，因此对数据包进行编码，这样即使数据包不是按顺序到达，接收方也可以根据数据包的序号纠正数据顺序。引入序号也可以避免由于重传可能引起的重复数据被提交的问题
- 计时器：解决数据丢失问题。当发生数据丢失时，接收方不会收到响应的数据报，自然不会对丢失的数据报进行确认，引入计时器可以解决这个问题，发送方在发送数据后就启动计时器，如果计时器发生超时没有收到接收方的确认，就主动重发数据包，从而纠正数据丢失问题，如果计时器设置时间太短，可能导致原本没有丢失的数据报也被重发，从而导致接收方接收到两份相同数据包副本，但是接收方可以根据重复数据包的序号判断出是重复数据包，将重复数据包丢弃

2. 停-等协议
实现可靠数据传输的最基本策略就是综合利用各种实现可靠数据传输的措施。基于重传截止的可靠数据传输协议成为自动重传请求协（ARQ）。最简单的ARQ协议就是停-等协议
停-等协议的注意特点就是每发送一个报文段后就停下来等待接收方的确认，这也是该协议名称的基本含义

基本工作流程是：发送方发送经过差错编码和编号的报文段，等待接收方的确认;接收方如果正确接收报文段，即差错检测无误且序号正确，则接收报文段，并向发送方发送ACK，否则丢弃报文段，并向发送方发送NAK;发送方如果收到ACK，则继续发送后续报文段，否则重发刚刚发送的报文段。

1. 关于差错检测。对于底层传输信道时可能产生比特差错的情况下，不进报文段的传输可能发生比特差错，ACk或NAK数据包在通过底层信道传输时同样可能会发生比特差错，因此对报文段和ACK或NAK数据报均需进行差错编码
2. 关于序列号。对于停-等协议，序列号字段只需要1位就足够，因为在停-等协议中只需利用报文段的序号区分是新发的报文段还是重传报文段
3. 关于ACK和NAK。在实际协议涉及过程中，通常不使用NAK，而只使用ACK进行确认，这样可以减少数据报的种类，降低协议的复杂性。通过在ACK数据包中带上所确认的报文段序列号替代NAK
4. 关于ACK或NAK差错。在ACK或NAK数据报中增加差错编码后，发送方可以检测出ACK会NAK是否发生错误，如果检测出差错，则不能准确判断接收方是否已正确接受报文段还是没有接收到，在这种情况下为了确保可靠传输，采取`有错推断`原则 即推断接收方没有正确接收响应的报文段。不过可以通过序号判断是否是重复报文段

停-等协议综合应用了差错检测，确认，重传，序号和计时器等措施，每种措施都在协议的运行中起到至关重要的作用，实现可靠数据传输。停-等协议的特点是简单，所需缓冲存储空间小

3. 滑动窗口协议

停-等协议是一个功能正确的协议，但其性能通常并不让人满意。停-等协议的主要性能问题在于它的停止-等待机制降低了信道利用率，信道利用率可以定义为发送方实际利用信道发送时间与总时间之比
解决这种特殊性能问题的一个简单方法是：不使用停-等协议的停止-等待运行方式，允许发送方在没有收到确认前联系发送多个分组，在这种可靠数据传输协议中，从发送方向接收方传送的系列分组可以看成是填充到一条流水线（或一条管道）中，故称为这种协议为流水线协议或管道协议

相对于停-等协议，流水线协议实现可靠数据传输时，需作出如下的改进：
- 必须增加分组序号范围。必须确保每个正在传送中，未被确认的分组有一个唯一的序号，以便准确区分每一个未被确认的分组
- 协议的发送方和接收方必须缓存多个分组，发送方最低限度应当能缓存那些已发送但是没有确认的分组，一旦其中任何一个或多个分组丢失或错误，发送方可以从缓存中取出相对应的分组，重发这些分组进行纠错。类似地，接收方或许也需要缓存那些已正确到达但不是按序到达的分组，以便等缺失人族到达后一并按序向上层提交数据

最典型的的流水线可靠数据传输是滑动窗口传输。滑动窗口协议对分组连续编号，发送方按流水线方式依序发送分组；接收方接受分组，按分组序号向上有序提交，并通过确认向发送方通告正确接收的分组序号。发送方能够连续发送多少未被确认的分组，主要取决于发送方缓存，接收方缓存，网络的带宽，时延积等因素，接收方可以缓存多少未按序到达的扥分组，主要却绝接收方的接收缓存大小等因素

滑动窗口协议实质上就是将可靠数据传输的工作过程，抽象到分组序号空间，即发送方确认分组按序发送，接收方确保分组按序提交。
















1. 用户数据报协议（UDP）
   
2. 传输控制协议（TCP）